import { NextResponse } from "next/server";
import { PDFDocument, StandardFonts } from "pdf-lib";
import fetch from "node-fetch";

export const runtime = "nodejs";

export async function POST(req: Request) {
  try {
    const { prompt, imageUrl } = await req.json();

    if (!prompt && !imageUrl) {
      return NextResponse.json(
        { error: "No data provided for PDF" },
        { status: 400 }
      );
    }

    const pdfDoc = await PDFDocument.create();
    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

    const page = pdfDoc.addPage([595, 842]);
    let y = 800;

    page.drawText("ARKEES AI â€“ Analytics Report", {
      x: 50,
      y,
      size: 18,
      font,
    });

    y -= 40;

    if (prompt) {
      page.drawText("Prompt:", { x: 50, y, size: 12, font });
      y -= 20;
      page.drawText(prompt, {
        x: 50,
        y,
        size: 11,
        font,
        maxWidth: 500,
        lineHeight: 14,
      });
      y -= 60;
    }

    if (imageUrl) {
      const imgRes = await fetch(imageUrl);
      const imgBytes = await imgRes.arrayBuffer();

      const image =
        imageUrl.endsWith(".png")
          ? await pdfDoc.embedPng(imgBytes)
          : await pdfDoc.embedJpg(imgBytes);

      const scaled = image.scale(0.5);

      page.drawImage(image, {
        x: 50,
        y: y - scaled.height,
        width: scaled.width,
        height: scaled.height,
      });
    }

    const pdfBytes = await pdfDoc.save();

    return new Response(pdfBytes, {
      headers: {
        "Content-Type": "application/pdf",
        "Content-Disposition":
          'attachment; filename="arkees-ai-report.pdf"',
      },
    });
  } catch (err) {
    console.error("PDF ERROR:", err);
    return NextResponse.json(
      { error: "Failed to generate PDF" },
      { status: 500 }
    );
  }
}
